# ---- Runtime base ----
FROM python:3.12-slim

ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PIP_NO_CACHE_DIR=1

WORKDIR /app

# System deps: curl for healthchecks; build tools only if needed by your reqs (kept minimal)
RUN apt-get update \
 && apt-get install -y --no-install-recommends curl \
 && rm -rf /var/lib/apt/lists/*

# Copy requirements first for Docker layer caching
COPY requirements.txt .

# Install python deps
RUN pip install --upgrade pip \
 && pip install -r requirements.txt

# Copy app source
COPY blockchain_backend ./blockchain_backend

# Create non-root user
RUN useradd -m appuser
USER appuser

# Expose internal Flask port
EXPOSE 5000

# Gunicorn tuning via envs (override at runtime if you want)
#   WORKERS: number of workers
#   THREADS: threads per worker
#   TIMEOUT: seconds before worker is killed
ENV WORKERS=2 THREADS=4 TIMEOUT=120

# Run Gunicorn (WSGI app is blockchain_backend.app:app)
CMD ["bash", "-lc", "gunicorn -b 0.0.0.0:5000 blockchain_backend.app:app --workers=${WORKERS} --threads=${THREADS} --timeout=${TIMEOUT} --graceful-timeout=30 --keep-alive=5"]
